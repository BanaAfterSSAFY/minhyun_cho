name: Gemini AI Reviewer

on:
  push:
    branches: [ main ]

jobs:
  review:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: '1.21'

      - name: Install Dependencies
        run: |
          if [ ! -f go.mod ]; then
            go mod init ai-reviewer
          fi
          go mod tidy

      - name: Run Gemini Review
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: go run main.go

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          # Go 스크립트가 생성한 reviews 폴더가 있는지 확인함
          if [ -d "reviews" ]; then
            git add reviews/
            # 변경사항(스테이징된 파일)이 있을 때만 커밋을 시도함
            if ! git diff --cached --quiet; then
              git commit -m "docs: generate AI reviews for all problems"
              git push
            else
              echo "커밋할 변경 사항이 없음."
            fi
          else
            echo "reviews 폴더가 생성되지 않았음."
          fi